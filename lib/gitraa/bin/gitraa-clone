#!/usr/bin/env bash
#
# Anononymously and asynchronously clone all user's pub repo warez in parallel
#
# Derek Callaway <decal {AT} sdf {D0T} org>
#
# Wed Oct 12 07:12:00 EDT 2016
#

# uncomment to enable born again debugging 
#set -x

# ware to stash da warezness
declare -xr GITAA_PATH_CLONE="$HOME/github"
# GNU parallel GOT's dis many Shakezpeer typewriter monkeys
declare -ir GITAA_JOBS_COUNT=8
# dont be readin my files fool
declare -ir GITAA_MODE_UMASK=0077
# somebody's bein nozey :^]
declare -ir GITAA_MODE_CDIRS=0700

### (o) DONUT ED IT ANYFING BLOW THIS (o) ###

source -- ../../include/gitaa-color
umask -- $GITAA_MODE_UMASK

if [ ! $1 ]
  then 
  echo "usage: $0 USER"
  echo '  USER  case-sensitive string for GitHub user name'
  echo ''
  echo "ex. $0 decal"

  exit 1
fi

readonly gitUser="$1"

function errx_show() {
  #echo -n -- "$1: " 
  #perror -v -- $2

  return 0
}

function errx_exit() {
  readonly reposPath=$(realpath $3)

  echo -n -- "$1: " 

  [ "$reposPath" ] && echo -n "${reposPath} "

  perror -v -- $2

  exit -- $2
}

if [ ! -d $GITAA_PATH_CLONE ] 
  then mkdir -- "$(realpath $GITAA_PATH_CLONE)" 2>/dev/null

  [ $? -ne 0 ] && errx_show 'mkdir' $? $GITAA_PATH_CLONE
fi

chmod $GITAA_MODE_CDIRS -- $GITAA_PATH_CLONE 2>/dev/null

[ $? -ne 0 ] && errx_show 'chmod' $?

cd -- ${GITAA_PATH_CLONE}

if [ ! -d $gitUser ]
  then mkdir -- $gitUser

  [ $? -ne 0 ] && errx_exit 'mkdir' $? $gitUser

  chmod $GITAA_MODE_CDIRS -- $gitUser 2>/dev/null

  [ $? -ne 0 ] && errx_show 'chmod' $?
fi

cd -- $gitUser

declare -xi waresDaWarez=0

while true
  do waresDaWarez=$(( 1 + waresDaWarez ))
  declare outputStr=`curl -sk "https://api.github.com/users/${gitUser}/repos?page=${numPage}&per_page=100" 2>&1` 

  if [ ! "$outputStr" ] 
    then echo "$0: No output received from GitHub API!"

    exit 2
  fi

  if [ "`echo "$outputStr" | grep 'ate limit'`" ]
    then echo "$0: GitHub API key's rate limit exceeded (try again later)"

    exit 3 
  fi

  export GITHUB_REPO_URLS=$(echo "$outputStr" | grep '"html_url": "' | grep "/${gitUser}/" | cut -d \" -f4 | sed 's!^git://!https://!g')

  [ $? -ne 0 ] && errx_show 'git' $?

  if [ ! "$GITHUB_REPO_URLS" ] 
    then echo "$0: Received output from GitHub API, but no repository references ?"
    echo "$0: Are you sure you entered the correct username ?"
    echo "$0: There must be repositories at https://github.com/${gitUser} !"

    exit 4
  fi
 
  which parallel |&> /dev/null 

  if [ $? -eq 0 ]
    then parallel -j${GITAA_JOBS_COUNT} nice git clone {1} ::: ${GITHUB_REPO_URLS}
  else
    declare -i countChocula=0

    for one in $GITHUB_REPO_URLS
      do countChocula=$(( $countChocula + 1 ))

      nice git clone $one &
    done

    for two in `seq 1 $countChocula`
      do wait $two
    done
  fi

  break
done

exit 0
