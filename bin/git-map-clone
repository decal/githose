#!/usr/bin/env bash
 
# http://stackoverflow.com/questions/19576742/

# ~/github your repos only
# ~/gitmap shell scripts that map operations onto repositories
# ~/contrib others' repos you're contributing to
# ~/repos others' repos you're just clone'ingi

readonly GITMAP_HOME_REPOS="~/repos" 
readonly GITMAP_HOME_CONTRIB="~/contrib"
readonly GITMAP_HOME_GITHUB="~/github"

umask 0027

if [ ! $1 ]
  then echo "usage: $0 USER"

  exit -1
fi

declare -xr gitUser="$1"

function cant_mkdir() {
  declare reposPath=$(realpath $1)
  echo -n $reposPath
  echo -n ' '
  perror -v $0

  exit -2
}

if [ ! -d $GITALL_HOME_REPOS ] 
  then mkdir $GITALL_HOME_REPOS
  [ $? ] cant_mkdir $? $GITALL_HOME_REPOS
  chmod 0750 $GITALL_HOME_REPOS
  [ $? ] cant_mkdir $? $GITALL_HOME_REPOS
fi

cd $GITALL_HOME_REPOS

mkdir -- ${gitUser}

chmod 0750 -- ~/repos ${gitUser} 

cd -- ${gitUser}

declare -xi numPage=0

while true
  do numPage=$(( 1 + numPage ))
  curl -sk "https://api.github.com/users/${gitUser}/repos?page=${numPage}&per_page=100" \
    | grep -e 'git_url*' | cut -d \" -f4 | nice -n 8 xargs -L1 git clone -- &
  [ ! $? ] && break
done

exit 0
