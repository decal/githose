#!/usr/bin/env bash

# http://stackoverflow.com/questions/19576742/
# ~/github your repos only
# ~/gitmap shell scripts that map operations onto repositories
# ~/contrib others' repos you're contributing to
# ~/repos others' repos you're just clone'ingi

# Uncomment this line to enable debugging
# set -x

readonly GITMAP_HOME_REPOS="~/repos" 
readonly GITMAP_HOME_CONTRIB="~/contrib"
readonly GITMAP_HOME_GITHUB="~/github"

### DO NOT CHANGE ANYTHING BELOW HERE UNLESS YOU KNOW WHAT YOU'RE DOING! ###

umask 0027

if [ ! $1 ]
  then echo "usage: $0 USER"

  exit 1
fi

readonly declare gitUser="$1"

function errx_show() {
  echo -n -- "$1: " 
  perror -v -- $2

  return 0
}

function errx_exit() {
  readonly declare reposPath=$(realpath $3)
  echo -n -- "$1: " 
  [ "$reposPath" ] && echo -n "${reposPath} "
  perror -v -- $2

  exit -- $2
}

if [ ! -d $GITALL_HOME_REPOS ] 
  then mkdir -- $GITALL_HOME_REPOS
  [ $? -ne 0 ] && errx_exit 'mkdir' $? $GITALL_HOME_REPOS
  chmod 0750 -- $GITALL_HOME_REPOS 2>/dev/null
  [ $? -ne 0 ] && errx_show 'chmod' $?
fi

cd -- ${GITALL_HOME_REPOS}

if [ ! -d $gitUser ]
  then mkdir -- ${gitUser}
  [ $? -ne 0 ] && errx_exit 'mkdir' $? ${gitUser}
  chmod 0750 -- ${gitUser} 2>/dev/null
  [ $? -ne 0 ] && errx_show 'chmod' $?
fi

cd -- ${gitUser}

declare -xi numPage=0

while true
  do numPage=$(( 1 + numPage ))
  declare outputStr=`curl -sk "https://api.github.com/users/${gitUser}/repos?page=${numPage}&per_page=100" 2>&1` 

  if [ "`echo $outputStr | grep 'rate limit exceeded'`" ]
    then echo "$0: GitHub API key's rate limit exceeded (try again later)"

    exit 2 
  fi

  echo $outputStr | grep -e 'git_url*' | cut -d \" -f4 | \ 
    sed 's!^git://!https://!' | nice -n 8 xargs -L1 git clone --

  [ $? -ne 0 ] && errx_show 'git' $?
done

exit 0
